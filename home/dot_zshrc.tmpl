# Fix zsh issue in Cursor IDE
# [[ "$COMPOSER_NO_INTERACTION" == "1" ]] && return

# ---- Optional zsh startup profiling ----

if [[ -n "${ZSH_PROFILE:-}" ]]; then
  zmodload zsh/zprof
fi

# -------- Pre-Initialization --------

# Powerlevel10k instant prompt (must be at the top) (only if not running in Cursor Agent)
# if [[ -z "$CURSOR_AGENT" ]]; then
  [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]] && source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
# fi

# -------- XDG variables --------

{{ template "zsh_env_xdg.tmpl" . }}

# -------- Custom variables --------

{{ template "zsh_env_custom.tmpl" . }}

export HOMEBREW_PREFIX="${HOMEBREW_PREFIX:-$(brew --prefix 2>/dev/null)}"
export DOTFILES="$(chezmoi source-path 2>/dev/null || echo "$HOME/.local/share/chezmoi")"

# -------- Tools configurations & Paths --------

# Android SDK
export ANDROID_HOME="$HOME/Library/Android/sdk"
export PATH="$ANDROID_HOME/platform-tools:$PATH"
export PATH="$ANDROID_HOME/emulator:$PATH"

# Homebrew
export HOMEBREW_NO_ANALYTICS=1
export HOMEBREW_INSTALL_BADGE="âœ“"
export PATH="$BREW_PREFIX/bin:$PATH"
export PATH="$BREW_PREFIX/sbin:$PATH"

# Mise
export MISE_NODE_COREPACK=true

# SQLite
export SQLITE_HISTORY="$XDG_STATE_HOME/sqlite_history"

# Custom scripts path
export PATH="$SCRIPTS:$PATH"

# -------- Global Configuration --------

# Locale
export LANG="en_US.UTF-8"

# Editor
if [[ -n "$SSH_CONNECTION" ]]; then
  export EDITOR="nano"
else
  export EDITOR="cursor"
fi

# -------- Shell (Zsh) configuration --------

# Create directories if they don't exist
mkdir -p "$XDG_STATE_HOME/zsh" "$XDG_CACHE_HOME/zsh" "$XDG_DATA_HOME/zsh/completions"

# Powerlevel10k theme (only if not running in Cursor Agent)
# if [[ -z "$CURSOR_AGENT" ]]; then
  [[ -f "$HOMEBREW_PREFIX/share/powerlevel10k/powerlevel10k.zsh-theme" ]] && source "$HOMEBREW_PREFIX/share/powerlevel10k/powerlevel10k.zsh-theme"
  [[ -f "$XDG_CONFIG_HOME/powerlevel10k/p10k.zsh" ]] && source "$XDG_CONFIG_HOME/powerlevel10k/p10k.zsh"
# fi

# Completion
fpath=("$XDG_DATA_HOME/zsh/completions" "$HOMEBREW_PREFIX/share/zsh-completions" $fpath)
autoload -Uz compinit
compinit -d "$XDG_CACHE_HOME/zsh/zcompdump-$ZSH_VERSION"
zstyle ":completion:*" use-cache on
zstyle ":completion:*" cache-path "$XDG_CACHE_HOME/zsh/zcompcache"
zstyle ":completion:*" menu select=2
zstyle ":completion:*" list-rows-first false
zstyle ":completion:*" list-packed false
zstyle ":completion:*" list-colors "${(s.:.)LS_COLORS:-}"
zstyle ":completion:*" matcher-list "m:{a-zA-Z}={A-Za-z}"
setopt auto_menu
setopt complete_in_word
setopt always_to_end
unsetopt menu_complete
unsetopt flowcontrol
bindkey "^I" expand-or-complete

# History
HISTFILE="$XDG_STATE_HOME/zsh/history"
HISTSIZE=50000
SAVEHIST=50000
HISTDUP=erase
setopt appendhistory
setopt incappendhistory
setopt share_history
setopt hist_fcntl_lock

setopt extended_history
setopt hist_find_no_dups
setopt hist_reduce_blanks
setopt hist_expire_dups_first
setopt hist_ignore_all_dups
setopt hist_ignore_space
setopt hist_save_no_dups
setopt hist_verify

# Fuzzy Finder (fzf)
if command -v fzf >/dev/null; then
  if [[ -r "$HOMEBREW_PREFIX/opt/fzf/shell/completion.zsh" && -r "$HOMEBREW_PREFIX/opt/fzf/shell/key-bindings.zsh" ]]; then
    source "$HOMEBREW_PREFIX/opt/fzf/shell/completion.zsh"
    source "$HOMEBREW_PREFIX/opt/fzf/shell/key-bindings.zsh"
  else
    fzf_zsh_init="$(fzf --zsh 2>/dev/null)" && eval "$fzf_zsh_init"
    unset fzf_zsh_init
  fi
fi

# Zsh History Substring Search
# HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_FOUND=true
# HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_NOT_FOUND=false
ZSH_HISTORY_SUBSTRING_SEARCH_FILE="$HOMEBREW_PREFIX/share/zsh-history-substring-search/zsh-history-substring-search.zsh"
[[ -f "$ZSH_HISTORY_SUBSTRING_SEARCH_FILE" ]] && source "$ZSH_HISTORY_SUBSTRING_SEARCH_FILE"
bindkey "^[[A" history-substring-search-up
bindkey "^[[B" history-substring-search-down

# -------- Aliases --------

# Navigation aliases
alias ...="../.."
alias ....="../../.."
alias .....="../../../.."
alias ......="../../../../.."

# Git cleanup aliases
alias cleanupbranches="delete-local-only-git-branches.sh"
alias cleanupbranch="cleanupbranches"
alias cleanupgitbranches="cleanupbranches"
alias cleanupgitbranch="cleanupbranches"

# PHP services aliases
alias startphp="start-php-services.sh"
alias stopphp="stop-php-services.sh"

# IP address aliases
alias ip="ipconfig getifaddr en0 || ipconfig getifaddr en1"

# Config files aliases
alias zshsource="source ~/.zshrc"
alias sshconfig="$EDITOR ~/.ssh/config"
alias hostsconfig="$EDITOR /etc/hosts"
alias hostconfig="hostsconfig"
alias vhostsconfig="$EDITOR $HOMEBREW_PREFIX/etc/httpd/extra/httpd-vhosts.conf"
alias vhostconfig="vhostsconfig"
alias httpdconfig="$EDITOR $HOMEBREW_PREFIX/etc/httpd/httpd.conf"
alias dnsmasqconfig="$EDITOR $HOMEBREW_PREFIX/etc/dnsmasq.conf"

# Sublime Text alias
alias sublime="/Applications/Sublime\ Text.app/Contents/SharedSupport/bin/subl --new-window $@"

# Better SQLite shell alias
if command -v rlwrap >/dev/null; then
  alias sqlite3="rlwrap sqlite3"
fi

# -------- Post-Initialization --------

# Mise - Tools version manager (must be at the bottom)
eval "$(mise activate zsh)"

# Zsh Syntax Highlighting (load late so it wraps final widgets)
ZSH_SYNTAX_HIGHLIGHTING_FILE="$HOMEBREW_PREFIX/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
[[ -f "$ZSH_SYNTAX_HIGHLIGHTING_FILE" ]] && source "$ZSH_SYNTAX_HIGHLIGHTING_FILE"

# ---- Optional zsh startup profiling ----

if [[ -n "${ZSH_PROFILE:-}" ]]; then
  zprof
fi
